<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>异丁烷脱氢反应模拟 (Isobutane Dehydrogenation)</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #0f172a;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
            color: white;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            background: linear-gradient(to bottom, #0f172a 0%, #1e293b 100%);
        }

        /* 左侧控制面板 */
        #hud-left {
            position: absolute;
            top: 15px;
            left: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
            z-index: 10;
        }

        .panel {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            pointer-events: auto;
            width: 230px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        h2 { 
            margin: 0 0 8px 0; 
            font-size: 0.85rem; 
            color: #facc15; /* 金色主题 */
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 4px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group { margin-bottom: 8px; }
        
        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #cbd5e1;
            margin-bottom: 2px;
        }
        
        input[type=range] {
            width: 100%;
            height: 4px;
            background: #475569;
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
            display: block;
            margin-top: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #facc15; /* 金色滑块 */
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { background: #fbbf24; }

        .val-disp { font-family: 'Courier New', monospace; color: #fbbf24; font-weight: bold; }

        /* 右上角统计面板 */
        #hud-stats {
            position: absolute;
            top: 15px;
            right: 15px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: flex-end;
        }
        
        .stat-box {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(250, 204, 21, 0.3); /* 金色边框 */
            padding: 10px 15px;
            border-radius: 8px;
            text-align: right;
            backdrop-filter: blur(4px);
            min-width: 140px;
        }
        .stat-label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 2px; }
        .stat-value { font-size: 1.2rem; font-weight: bold; color: white; font-family: 'Courier New', monospace; }
        .stat-value.prod1 { color: #facc15; } /* 异丁烯颜色 */
        .stat-value.prod2 { color: #ffffff; } /* 氢气颜色 */

        /* 右下角图例 */
        #hud-bottom-right {
            position: absolute;
            bottom: 15px;
            right: 15px;
            pointer-events: none;
        }
        .legend {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            background: rgba(0,0,0,0.6);
            padding: 8px 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .legend-item { display: flex; align-items: center; gap: 5px; color: #e2e8f0; }
        .dot { width: 10px; height: 10px; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); }

        /* 按钮样式 */
        .btn-reset {
            width: 100%;
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
            transition: background 0.2s;
        }
        .btn-reset:hover { background: #dc2626; }

    </style>
</head>
<body>

<div id="game-container">
    <div id="hud-left">
        <!-- 环境参数 -->
        <div class="panel">
            <h2>反应环境 (Pt-Catalyst)</h2>
            <div class="control-group">
                <div class="label-row">
                    <span>温度 (Temp)</span>
                    <span id="disp-temp" class="val-disp">600°C</span>
                </div>
                <input type="range" id="in-temp" min="0" max="800" value="600">
            </div>
            <div class="control-group">
                <div class="label-row">
                    <span>压力 (Pressure)</span>
                    <span id="disp-pres" class="val-disp">1.0 bar</span>
                </div>
                <input type="range" id="in-pres" min="0.1" max="30" step="0.1" value="1.0">
            </div>
            <div style="font-size:0.7rem; color:#64748b; margin-top:5px; text-align:right;">
                速率: <span id="disp-rate" style="color:#facc15">1.0x</span>
            </div>
        </div>

        <!-- 物质控制 -->
        <div class="panel">
            <h2>反应物数量</h2>
            <div class="control-group">
                <div class="label-row">
                    <span>异丁烷 (Reactant)</span>
                    <span id="disp-c4h10-cnt" class="val-disp">20</span>
                </div>
                <input type="range" id="in-c4h10-cnt" min="1" max="100" value="20">
            </div>
            <!-- 仅仅为了作为背景气体存在，或者观察逆反应(虽然本游戏主打正反应) -->
            <div class="control-group">
                <div class="label-row">
                    <span>H₂ (Background)</span>
                    <span id="disp-h2-cnt" class="val-disp">5</span>
                </div>
                <input type="range" id="in-h2-cnt" min="0" max="50" value="5">
            </div>
            <button class="btn-reset" id="btn-reset">重置模拟 / Reset</button>
        </div>
    </div>

    <!-- 右上角统计 -->
    <div id="hud-stats">
        <div class="stat-box">
            <div class="stat-label">Isobutene Generated</div>
            <div class="stat-value prod1" id="stat-c4h8-total">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">H₂ Generated</div>
            <div class="stat-value prod2" id="stat-h2-total">0</div>
        </div>
    </div>

    <!-- 右下角图例 -->
    <div id="hud-bottom-right">
        <div class="legend">
            <div class="legend-item"><div class="dot" style="background:#94a3b8"></div>C</div>
            <div class="legend-item"><div class="dot" style="background:#ffffff"></div>H</div>
            <div class="legend-item"><div class="dot" style="background:#facc15"></div>Pt/Cr (催化剂)</div>
        </div>
    </div>

    <canvas id="simCanvas"></canvas>
</div>

<script>
    /**
     * 异丁烷脱氢模拟 (Isobutane Dehydrogenation)
     * 反应: i-C4H10 -> i-C4H8 + H2
     * * 逻辑:
     * 1. Isobutane (C4H10) 吸附到表面。
     * 2. 在表面分解 (Decomposition): C4H10_ads -> C4H8_ads + 2 H_ads
     * 3. H_ads 表面扩散寻找另一个 H_ads -> H2 (gas)
     * 4. C4H8_ads (异丁烯) 直接脱附 -> C4H8 (gas)
     */

    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');

    // UI Inputs
    const UI = {
        temp: document.getElementById('in-temp'),
        pres: document.getElementById('in-pres'),
        c4h10Cnt: document.getElementById('in-c4h10-cnt'),
        h2Cnt: document.getElementById('in-h2-cnt'),
        dTemp: document.getElementById('disp-temp'),
        dPres: document.getElementById('disp-pres'),
        dRate: document.getElementById('disp-rate'),
        dC4H10: document.getElementById('disp-c4h10-cnt'),
        dH2: document.getElementById('disp-h2-cnt'),
        btnReset: document.getElementById('btn-reset'),
        statC4H8: document.getElementById('stat-c4h8-total'),
        statH2: document.getElementById('stat-h2-total')
    };

    // 常量定义
    const COLORS = {
        C: '#94a3b8', 
        H: '#ffffff', 
        Cat: '#facc15', // 金色
        CatDark: '#ca8a04',
        BOND: '#64748b',
        BOND_DOUBLE: '#e2e8f0' // 异丁烯的双键颜色稍微亮一点
    };
    
    const ATOM_RADII = { C: 9, H: 4, Cat: 12 };

    // 分子蓝图
    // i-C4H10: 中心C + 3个周围C
    const BLUEPRINTS = {
        // 异丁烷 (Isobutane)
        C4H10: { 
            atoms: [
                {t:'C',x:0,y:0},     // Center
                {t:'C',x:0,y:-16},   // Top
                {t:'C',x:-14,y:9},   // Left
                {t:'C',x:14,y:9},    // Right
                // H atoms (visual representation, not all 10 needed, just to look saturated)
                {t:'H',x:0,y:-24}, {t:'H',x:-6,y:-18}, {t:'H',x:6,y:-18}, // Top C hydrogens
                {t:'H',x:-20,y:6}, {t:'H',x:-18,y:14}, {t:'H',x:-10,y:15}, // Left C hydrogens
                {t:'H',x:20,y:6},  {t:'H',x:18,y:14},  {t:'H',x:10,y:15},  // Right C hydrogens
                {t:'H',x:0,y:0} // Center H (actually hidden behind usually, but let's put it)
            ], 
            bonds: [[0,1],[0,2],[0,3]] 
        },
        
        // 异丁烯 (Isobutene) - 少了2个H，有一个双键
        C4H8: { 
            atoms: [
                {t:'C',x:0,y:0},
                {t:'C',x:0,y:-16}, // Double bond here
                {t:'C',x:-14,y:9},
                {t:'C',x:14,y:9},
                // Fewer H atoms on Top and Center
                {t:'H',x:-6,y:-18}, {t:'H',x:6,y:-18}, // Top C has 2 H
                {t:'H',x:-20,y:6}, {t:'H',x:-18,y:14}, {t:'H',x:-10,y:15},
                {t:'H',x:20,y:6},  {t:'H',x:18,y:14},  {t:'H',x:10,y:15}
            ], 
            bonds: [[0,1],[0,2],[0,3]],
            doubleBondIndex: 0 // Index in bonds array that is double
        },

        H2: { atoms: [{t:'H',x:-5,y:0},{t:'H',x:5,y:0}], bonds: [[0,1]] },

        // 吸附态
        H_ads: { atoms: [{t:'H',x:0,y:0}], bonds: [] },
        
        // 异丁烷吸附态 (结构稍微压扁一点)
        C4H10_ads: { 
             atoms: [{t:'C',x:0,y:0},{t:'C',x:0,y:-14},{t:'C',x:-12,y:8},{t:'C',x:12,y:8}], 
             bonds: [[0,1],[0,2],[0,3]] 
        },
        // 异丁烯吸附态
        C4H8_ads: { 
             atoms: [{t:'C',x:0,y:0},{t:'C',x:0,y:-14},{t:'C',x:-12,y:8},{t:'C',x:12,y:8}], 
             bonds: [[0,1],[0,2],[0,3]],
             doubleBondIndex: 0
        }
    };

    // ---------------- 全局状态 ----------------
    let width, height, catalystY;
    let catalystAtoms = [];
    
    let flyingMolecules = [];
    let adsorbedMolecules = [];

    let gameStats = {
        totalC4H8: 0,
        totalH2: 0
    };

    let params = {
        temp: 600,
        pressure: 1.0,
        speedFactor: 1.0,
        targetC4H10: 20,
        targetH2: 5
    };

    // ---------------- 核心类定义 ----------------

    class Molecule {
        constructor(type, x, y) {
            this.type = type;
            this.bp = BLUEPRINTS[type];
            this.x = x;
            this.y = y;
            
            const spd = 2.0 * (0.5 + Math.random());
            const ang = Math.random() * Math.PI * 2;
            this.vx = Math.cos(ang) * spd;
            this.vy = Math.sin(ang) * spd;
            this.ang = Math.random() * 6;
            this.vAng = (Math.random()-0.5) * 0.1;

            this.state = 'flying'; 
            this.opacity = 0; 
        }

        update(dt) {
            if(this.opacity < 1) this.opacity += 0.05;

            this.x += this.vx * dt;
            this.y += this.vy * dt;
            this.ang += this.vAng * dt;

            if (this.state === 'flying') {
                const bottomLimit = catalystY - 45;
                if(this.x < 0) { this.x=0; this.vx = Math.abs(this.vx); }
                if(this.x > width) { this.x=width; this.vx = -Math.abs(this.vx); }
                if(this.y < 0) { this.y=0; this.vy = Math.abs(this.vy); }
                if(this.y > bottomLimit) { this.y=bottomLimit; this.vy = -Math.abs(this.vy); }

                // 随机俯冲 (受压力影响)
                if(Math.random() < 0.002 * params.pressure) {
                    this.state = 'migrating';
                    this.vy = Math.abs(this.vy) + 2; 
                }

            } else if (this.state === 'migrating') {
                if (this.y >= catalystY - 30) {
                    this.tryAdsorb();
                }
                if(this.x < 0 || this.x > width) this.vx *= -1;

            } else if (this.state === 'leaving') {
                if(this.y < -50 || this.x < -50 || this.x > width+50) {
                    return 'remove';
                }
            }
        }

        tryAdsorb() {
            if (this.type === 'C4H10') {
                // 吸附变为 C4H10_ads
                spawnAdsorbed('C4H10_ads', this.x, this.y);
                this.dead = true; 
            } else if (this.type === 'H2') {
                // H2 -> 2 H(ads) (虽然主要是反应生成H2，但平衡也允许吸附)
                spawnAdsorbed('H_ads', this.x - 8, this.y);
                spawnAdsorbed('H_ads', this.x + 8, this.y);
                this.dead = true;
            } else if (this.type === 'C4H8') {
                // 产物也可以吸附 (逆反应)
                spawnAdsorbed('C4H8_ads', this.x, this.y);
                this.dead = true;
            } else {
                // 其他情况反弹
                this.state = 'flying';
                this.vy = -Math.abs(this.vy);
            }
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.ang);
            ctx.globalAlpha = this.opacity;
            
            // Draw Bonds
            ctx.lineCap = "round";
            this.bp.bonds.forEach((b, idx) => {
                const a1 = this.bp.atoms[b[0]];
                const a2 = this.bp.atoms[b[1]];
                ctx.beginPath();
                ctx.moveTo(a1.x, a1.y);
                ctx.lineTo(a2.x, a2.y);
                
                // 双键检测
                if (this.bp.doubleBondIndex === idx) {
                     ctx.strokeStyle = COLORS.BOND_DOUBLE;
                     ctx.lineWidth = 6;
                     ctx.stroke();
                     // 中间画一条黑线分开模拟双键
                     ctx.strokeStyle = '#0f172a';
                     ctx.lineWidth = 2;
                     ctx.stroke();
                } else {
                    ctx.strokeStyle = COLORS.BOND;
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
            });

            // Draw Atoms
            this.bp.atoms.forEach(a => {
                ctx.beginPath();
                ctx.arc(a.x, a.y, ATOM_RADII[a.t], 0, Math.PI*2);
                ctx.fillStyle = COLORS[a.t] || COLORS.C;
                ctx.fill();
                // 简单阴影
                ctx.strokeStyle = 'rgba(0,0,0,0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();
            });

            ctx.restore();
        }
    }

    class Adsorbed {
        constructor(type, x, y) {
            this.type = type;
            this.bp = BLUEPRINTS[type];
            this.x = x;
            this.y = y;
            this.timer = 0;
            this.vx = (Math.random()-0.5) * 1.5;
            this.dead = false;
        }

        update(dt) {
            this.timer += dt;
            
            const diffusionSpeed = this.vx * dt * (1 + (params.temp/800));
            this.x += diffusionSpeed;

            if(this.x < 20) { this.x = 20; this.vx *= -1; }
            if(this.x > width-20) { this.x = width-20; this.vx *= -1; }

            this.y = catalystY - 15 + Math.sin(this.timer*0.2 + this.x)*2;

            // --- 反应逻辑 ---

            // 1. 异丁烷分解 (C4H10_ads -> C4H8_ads + 2 H_ads)
            if (this.type === 'C4H10_ads') {
                // 温度越高，分解概率越大
                const reactionProb = 0.005 * (params.temp / 400) * params.speedFactor;
                if (Math.random() < reactionProb) {
                    this.decompose();
                }
            }

            // 2. 异丁烯脱附 (C4H8_ads -> C4H8 gas)
            if (this.type === 'C4H8_ads') {
                const desorbProb = 0.01 * (params.temp / 500) * params.speedFactor;
                // 稍微延时，别刚生成就跑
                if (this.timer > 30 && Math.random() < desorbProb) {
                    this.desorb('C4H8');
                }
            }

            // 3. H 结合 (2 H_ads -> H2 gas)
            if (this.type === 'H_ads') {
                this.findPartner(dt);
            }
        }

        decompose() {
            // 变成 C4H8_ads
            this.type = 'C4H8_ads';
            this.bp = BLUEPRINTS['C4H8_ads'];
            // 吐出 2个 H
            spawnAdsorbed('H_ads', this.x - 10, this.y);
            spawnAdsorbed('H_ads', this.x + 10, this.y);
            // 这里我们不销毁自己，而是改变自己的类型，视觉上平滑过渡
        }

        findPartner(dt) {
            // 寻找另一个 H
            let closest = null;
            let minDist = 1000;

            for (let other of adsorbedMolecules) {
                if (other.type === 'H_ads' && other !== this && !other.dead) {
                    const dx = other.x - this.x;
                    const dy = other.y - this.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < minDist) {
                        minDist = dist;
                        closest = other;
                    }
                }
            }

            if (closest && minDist < 100) {
                // 靠近
                const dx = closest.x - this.x;
                const speed = 3.0 * dt * params.speedFactor;
                if(dx > 0) this.x += speed; else this.x -= speed;

                // 结合
                if (minDist < 20) {
                    this.dead = true;
                    closest.dead = true;
                    
                    const h2 = new Molecule('H2', this.x, this.y - 20);
                    h2.state = 'leaving';
                    h2.vy = -5; // H2 很轻，飞得快
                    h2.vx = (Math.random()-0.5)*4;
                    flyingMolecules.push(h2);

                    gameStats.totalH2++;
                    UI.statH2.innerText = gameStats.totalH2;
                }
            }
        }

        desorb(productType) {
            this.dead = true;
            const p = new Molecule(productType, this.x, this.y - 20);
            p.state = 'leaving';
            p.vy = -2 - Math.random(); 
            p.vx = (Math.random()-0.5)*2;
            flyingMolecules.push(p);

            if(productType === 'C4H8') {
                gameStats.totalC4H8++;
                UI.statC4H8.innerText = gameStats.totalC4H8;
            }
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            
            // 简单的呼吸效果
            const scale = 1 + Math.sin(this.timer * 0.1) * 0.02;
            ctx.scale(scale, scale);

            // Draw Bonds
            ctx.lineCap = "round";
            this.bp.bonds.forEach((b, idx) => {
                const a1 = this.bp.atoms[b[0]];
                const a2 = this.bp.atoms[b[1]];
                ctx.beginPath();
                ctx.moveTo(a1.x, a1.y);
                ctx.lineTo(a2.x, a2.y);
                 if (this.bp.doubleBondIndex === idx) {
                     ctx.strokeStyle = COLORS.BOND_DOUBLE;
                     ctx.lineWidth = 5;
                     ctx.stroke();
                     ctx.strokeStyle = '#0f172a'; // gap
                     ctx.lineWidth = 1;
                     ctx.stroke();
                } else {
                    ctx.strokeStyle = COLORS.BOND;
                    ctx.lineWidth = 4;
                    ctx.stroke();
                }
            });

            // Draw Atoms
            this.bp.atoms.forEach(a => {
                ctx.beginPath();
                ctx.arc(a.x, a.y, ATOM_RADII[a.t], 0, Math.PI*2);
                ctx.fillStyle = COLORS[a.t] || COLORS.C;
                ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.5)';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
            ctx.restore();
        }
    }

    // ---------------- 系统功能 ----------------

    function spawnAdsorbed(type, x, y) {
        adsorbedMolecules.push(new Adsorbed(type, x, y));
    }

    function managePopulation() {
        let currentC4H10 = 0;
        let currentH2 = 0;

        const countEntity = (type) => {
            if (['C4H10', 'C4H10_ads'].includes(type)) currentC4H10++;
            // 这里 H2 只统计单纯的 H2 分子或 H_ads 对，为了维持背景浓度
            if (['H2', 'H_ads'].includes(type)) currentH2++;
        };

        flyingMolecules.forEach(m => countEntity(m.type));
        adsorbedMolecules.forEach(m => countEntity(m.type));

        if (currentC4H10 < params.targetC4H10 && Math.random() < 0.1) {
            spawnFlying('C4H10');
        }
        if (currentH2 < params.targetH2 && Math.random() < 0.1) {
            spawnFlying('H2');
        }
    }

    function spawnFlying(type) {
        const x = Math.random() * (width - 40) + 20;
        const m = new Molecule(type, x, -40);
        m.vy = Math.abs(m.vy) + 1;
        flyingMolecules.push(m);
    }

    function resetGame() {
        flyingMolecules = [];
        adsorbedMolecules = [];
        gameStats.totalC4H8 = 0;
        gameStats.totalH2 = 0;
        UI.statC4H8.innerText = "0";
        UI.statH2.innerText = "0";
        // 预生成
        for(let i=0; i<params.targetC4H10; i++) spawnFlying('C4H10');
        for(let i=0; i<params.targetH2; i++) spawnFlying('H2');
    }

    // ---------------- 渲染与循环 ----------------

    function initCatalyst() {
        catalystAtoms = [];
        const r = ATOM_RADII.Cat;
        const cols = Math.ceil(width / (r*2)) + 2;
        for(let i=0; i<cols; i++) {
            catalystAtoms.push({x: i*r*2, y: catalystY});
            catalystAtoms.push({x: i*r*2 + r, y: catalystY + r*1.732});
        }
    }

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        catalystY = height - 50;
        initCatalyst();
    }

    function updateParamsFromUI() {
        const T = parseInt(UI.temp.value);
        const P = parseFloat(UI.pres.value);
        const C4 = parseInt(UI.c4h10Cnt.value);
        const H2 = parseInt(UI.h2Cnt.value);

        params.temp = T;
        params.pressure = P;
        params.targetC4H10 = C4;
        params.targetH2 = H2;

        const tempMult = Math.exp(0.008 * (T - 600));
        const presMult = P; 
        
        let rate = tempMult * presMult;
        if (rate > 20) rate = 20; 

        params.speedFactor = rate;

        UI.dTemp.innerText = T + "°C";
        UI.dPres.innerText = P.toFixed(1) + " bar";
        UI.dRate.innerText = rate.toFixed(1) + "x";
        UI.dC4H10.innerText = C4;
        UI.dH2.innerText = H2;
    }

    function loop() {
        ctx.clearRect(0, 0, width, height);

        // 催化剂 (金色)
        catalystAtoms.forEach(p => {
            ctx.beginPath();
            ctx.arc(p.x, p.y, ATOM_RADII.Cat, 0, Math.PI*2);
            ctx.fillStyle = COLORS.Cat;
            ctx.fill();
            const g = ctx.createRadialGradient(p.x-4, p.y-4, 2, p.x, p.y, ATOM_RADII.Cat);
            g.addColorStop(0, '#fde047');
            g.addColorStop(1, '#ca8a04');
            ctx.fillStyle = g;
            ctx.fill();
            ctx.strokeStyle = '#a16207';
            ctx.stroke();
        });

        // 物理更新
        let steps = Math.ceil(params.speedFactor);
        if (steps < 1) steps = 1;
        if (steps > 10) steps = 10; 
        
        const dt = params.speedFactor / steps;

        for (let s=0; s<steps; s++) {
            for (let i = flyingMolecules.length - 1; i >= 0; i--) {
                const res = flyingMolecules[i].update(dt);
                if (res === 'remove' || flyingMolecules[i].dead) {
                    flyingMolecules.splice(i, 1);
                }
            }
            for (let i = adsorbedMolecules.length - 1; i >= 0; i--) {
                adsorbedMolecules[i].update(dt);
                if (adsorbedMolecules[i].dead) {
                    adsorbedMolecules.splice(i, 1);
                }
            }
        }

        managePopulation();

        adsorbedMolecules.forEach(m => m.draw(ctx));
        flyingMolecules.forEach(m => m.draw(ctx));

        requestAnimationFrame(loop);
    }

    // 事件监听
    window.addEventListener('resize', resize);
    [UI.temp, UI.pres, UI.c4h10Cnt, UI.h2Cnt].forEach(el => {
        el.addEventListener('input', updateParamsFromUI);
    });
    UI.btnReset.addEventListener('click', resetGame);

    // 启动
    resize();
    updateParamsFromUI();
    // 初始生成
    for(let i=0; i<15; i++) spawnFlying('C4H10');
    loop();

</script>
</body>
</html>